<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم رموز القبائل</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      background: linear-gradient(135deg, #FAF3E0, #F2E8D5);
      color: #5C4033;
      min-height: 100vh;
      display: flex;
    }
    
    /* تصميم صفحة تسجيل الدخول */
    #login-screen {
      background: rgba(255, 255, 255, 0.7);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      margin: 150px auto;
      max-width: 320px;
      width: 90%;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    #login-screen h2 {
      margin-bottom: 20px;
      color: #3E2723;
    }
    
    #login-screen input, #login-screen button {
      width: 100%;
      margin: 12px 0;
      padding: 12px;
      border-radius: 30px;
      border: 1px solid #D2B48C;
      box-sizing: border-box;
      border-color: #CD853F;
      box-shadow: 0 0 8px rgba(205, 133, 63, 0.2);
      background-color: #fff;
      color: #3E2723;
      text-align: center;
      font-size: 16px;
      /* font-family: "IBM Plex Sans Arabic", sans-serif; */ /* Reverted: Font inherited from body */
    }
    
    #login-screen input:focus, #login-screen button:focus {
      transition: border-color 0.3s, box-shadow 0.3s;
      border-color: #b87333; 
      box-shadow: 0 0 10px rgba(184, 115, 51, 0.5);
    }

    /* تطبيق الخط على placeholder في شاشة تسجيل الدخول */
    #login-screen input::placeholder {
      font-family: "IBM Plex Sans Arabic", sans-serif;
      color: #A08C7D; /* لون placeholder مقترح */
    }
    
    #login-screen button {
      background: linear-gradient(90deg, #CD853F, #D2B48C);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s;
      border: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      font-family: "IBM Plex Sans Arabic", sans-serif; /* Ensure font is applied */
    }
    
    #login-screen button:hover {
      background: linear-gradient(90deg, #b87333, #c8a070);
    }
    
    .input-icon-container {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      font-size: 20px;
      pointer-events: none;
      color: #D2B48C;
    }
    
    /* القائمة الجانبية */
    .sidebar {
      width: 250px;
      background: rgba(139, 69, 19, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      height: 100vh;
      position: fixed;
      right: 0;
      top: 0;
      transition: transform 0.3s ease;
      z-index: 1000;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar.collapsed {
      transform: translateX(250px);
    }
    
    .sidebar-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-header h2 {
      color: #fff;
      margin: 0;
      font-size: 1.2rem;
    }
    
    .toggle-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .toggle-btn.active {
      transform: rotate(180deg);
    }
    
    .sidebar-menu {
      padding: 20px 0;
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .sidebar-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 12px 20px;
      color: #fff;
      text-decoration: none;
      transition: background 0.3s;
      border-radius: 4px;
      margin: 0 10px;
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-menu a i {
      margin-left: 10px;
      font-size: 1.2rem;
      vertical-align: middle;
    }
    
    .sidebar-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
    }
    
    /* المحتوى الرئيسي */
    .main-content {
      flex: 1;
      padding: 20px;
      margin-right: 250px;
      transition: margin 0.3s ease;
      margin-top: 70px; /* تم تعديل الهامش العلوي لإفساح المجال للهيدر */
    }
    
    .main-content.expanded {
      margin-right: 0;
    }
    
    /* رأس الصفحة للجوال */
    .mobile-header {
      display: none; /* Hidden by default */
      padding: 15px;
      background: rgba(139, 69, 19, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      color: #fff;
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: background 0.3s ease;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mobile-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* الهيدر الثابت */
    .fixed-header {
      padding: 15px;
      background: rgba(139, 69, 19, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      color: #fff;
      position: fixed;
      top: 0;
      right: 250px;
      left: 0;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: none; /* Hidden by default */
      justify-content: space-between;
      align-items: center;
      transition: right 0.3s ease;
    }
    
    .fixed-header.expanded {
      right: 0;
    }
    
    .header-title {
      margin: 0;
      font-size: 1.2rem;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
    }
    
    .header-actions .btn {
      margin-left: 10px;
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
    /* الأقسام */
    .section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .section h3 {
      margin-top: 0;
      color: #3E2723;
      border-bottom: 2px solid #D2B48C;
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    /* النماذج */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #5C4033;
      font-weight: bold;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .form-group label.label-highlight {
      color: #CD853F; /* Golden color - Reverted, no longer used here */
    }
    
    .form-control {
      width: 95%; /* تم تقصير العرض قليلاً */
      padding: 10px;
      border: 1px solid #D2B48C;
      border-radius: 5px;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      color: #3E2723;
      transition: border-color 0.3s, box-shadow 0.3s;
      box-sizing: border-box; /* Added for better width control */
      margin-right: auto; /* Center align if needed */
      margin-left: auto; /* Center align if needed */
      display: block; /* Ensure it takes block space */
    }
    
    .form-control:focus {
      border-color: #CD853F;
      box-shadow: 0 0 5px rgba(205, 133, 63, 0.3); 
      outline: none;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, #CD853F, #D2B48C);
      color: #fff;
    }
    
    .btn-primary:hover {
      background: linear-gradient(90deg, #D2B48C, #CD853F);
    }
    
    .btn-danger {
      background: linear-gradient(90deg, #d9534f, #c9302c);
      color: #fff;
    }
    
    .btn-danger:hover {
      background: linear-gradient(90deg, #c9302c, #d9534f);
    }
    
    .btn-secondary {
      background: linear-gradient(90deg, #6c757d, #5a6268);
      color: #fff;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(90deg, #5a6268, #6c757d);
    }
    
    /* تحميل الصور */
    .image-upload {
      border: 2px dashed #D2B48C;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      transition: border-color 0.3s;
      width: 95%; /* Match form control width */
      box-sizing: border-box; /* Added for better width control */
      margin-right: auto;
      margin-left: auto;
      display: block;
    }
    
    .image-upload:hover {
      border-color: #CD853F;
    }
    
    .image-upload input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .image-upload i {
      font-size: 40px;
      color: #D2B48C;
      margin-bottom: 10px;
    }
    
    .image-upload p {
      margin: 0;
      color: #5C4033;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .image-preview {
      max-width: 100%;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
      max-height: 300px;
    }
    
    /* رسائل النجاح والخطأ */
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      width: 95%; /* Match form control width */
      box-sizing: border-box; /* Added for better width control */
      margin-right: auto;
      margin-left: auto;
    }
    
    .alert-success {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    
    .alert-danger {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    
    /* تصميم متجاوب */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(250px);
        width: 250px;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-right: 0;
        padding-top: 70px;
      }
      
      .mobile-header {
        /* Display handled by JS */
        justify-content: space-between;
        align-items: center;
      }
      
      .mobile-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-family: "IBM Plex Sans Arabic", sans-serif;
      }
      
      .fixed-header {
        display: none !important; /* Ensure fixed header is never shown on mobile */
      }
      
      .stats-container {
        flex-direction: column;
      }
      
      .stat-card {
        margin-bottom: 10px;
      }
      
      .form-control, .image-upload, .alert {
          width: 100%; /* Full width on mobile */
      }
    }
    
    /* تنسيق إضافي لقسم إدارة شيوخ القبائل */
    #sheikhManagementSection .image-preview-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    #sheikhManagementSection .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* تنسيق لرسائل النجاح والفشل */
    .result-message {
      padding: 15px;
      border-radius: 5px;
      margin: 15px auto; /* Center align */
      display: none;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      width: 95%; /* Match form control width */
      box-sizing: border-box;
    }
    
    .success-message {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    
    .error-message {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    
    /* تنسيق للمؤشر أثناء التحميل */
    .loading-spinner {
      display: none;
      text-align: center;
      margin: 15px 0;
    }
    
    .loading-spinner i {
      font-size: 24px;
      color: #CD853F;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* تنسيق لقسم إحصائيات الزوار */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #fff, #f8f8f8);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 200px;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card h4 {
      margin-top: 0;
      color: #5C4033;
      font-size: 1rem;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #CD853F;
      margin: 10px 0;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .stat-card .stat-label {
      color: #8B4513;
      font-size: 0.9rem;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    /* تنسيق للرسم البياني */
    .chart-container {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      height: 300px;
    }
    
    /* تنسيق لجدول شيوخ القبائل */
    .sheikhs-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .sheikhs-table th, .sheikhs-table td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .sheikhs-table th {
      background-color: #f5f5f5;
      color: #5C4033;
      font-weight: bold;
    }
    
    .sheikhs-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .sheikhs-table .sheikh-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      vertical-align: middle; /* Align image nicely */
    }
    
    .sheikhs-table .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center; /* Center buttons */
    }
    
    .sheikhs-table .action-buttons button {
      padding: 5px 10px;
      font-size: 0.8rem;
    }
    
    /* تنسيق للمؤشر "جار المعالجة" */
    .processing-indicator {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .processing-indicator .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #CD853F;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    .processing-indicator p {
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      margin: 0;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    /* تنسيق لقسم زوار الموقع */
    .visitor-stats-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .filter-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(90deg, #CD853F, #D2B48C);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .filter-btn:hover {
      background: linear-gradient(90deg, #b87333, #c8a070);
    }
    
    .visitor-stats-display {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      font-family: "IBM Plex Sans Arabic", sans-serif;
    }
    
    .visitor-stats-display p {
      margin: 5px 0;
      font-size: 16px;
    }
    
    .visitor-stats-display strong {
      color: #CD853F;
      font-size: 1.2em;
    }
    
    hr.section-divider {
      border: 0;
      height: 1px;
      background-image: linear-gradient(to right, rgba(139, 69, 19, 0), rgba(139, 69, 19, 0.3), rgba(139, 69, 19, 0));
      margin: 30px 0;
    }
    
    /* Overlay for sidebar on mobile */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998; /* Below sidebar */
    }

  </style>
</head>
<body>
  <!-- شاشة تسجيل الدخول -->
  <div id="login-screen">
    <h2>تسجيل الدخول للوحة التحكم</h2>
    <div class="input-icon-container">
      <input type="text" id="username" placeholder="اسم المستخدم" required>
      <i class="bx bx-user input-icon"></i>
    </div>
    <div class="input-icon-container">
      <input type="password" id="password" placeholder="كلمة المرور" required>
      <i class="bx bx-lock-alt input-icon"></i>
    </div>
    <button id="loginButton">دخول</button>
  </div>

  <!-- القائمة الجانبية -->
  <div class="sidebar collapsed" id="sidebar" style="display: none;"> <!-- Hidden by default -->
    <div class="sidebar-header">
      <h2>لوحة التحكم</h2>
      <button class="toggle-btn" id="sidebarToggle">
        <i class="bx bx-menu"></i>
      </button>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="#" data-section="dashboardSection" class="active"><i class="bx bxs-dashboard"></i> لوحة المعلومات</a></li>
        <li><a href="#" data-section="addTribeSection"><i class="bx bx-plus-circle"></i> إضافة قبيلة</a></li>
        <li><a href="#" data-section="deleteTribeSection"><i class="bx bx-trash"></i> حذف قبيلة</a></li>
        <li><a href="#" data-section="addHistorySection"><i class="bx bx-book-add"></i> إضافة معلومات قبيلة</a></li>
        <li><a href="#" data-section="deleteHistorySection"><i class="bx bx-book-alt"></i> حذف معلومات قبيلة</a></li>
        <li><a href="#" data-section="sheikhManagementSection"><i class="bx bx-user-pin"></i> إدارة شيوخ القبائل</a></li>
        <li><a href="#" data-section="deleteSheikhSection"><i class="bx bx-user-minus"></i> حذف شيخ قبيلة</a></li>
        <li><a href="#" data-section="visitorStatsSection"><i class="bx bx-line-chart"></i> إحصائيات الزوار</a></li>
        <li><a href="#" id="logoutLink"><i class="bx bx-log-out"></i> تسجيل الخروج</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      &copy; 2024 - رموز القبائل
      <br>
      <span id="sidebarVisitorCount"></span>
    </div>
  </div>
  
  <!-- Overlay for mobile sidebar -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- رأس الصفحة للجوال -->
  <div class="mobile-header" style="display: none;">
    <h2>لوحة تحكم رموز القبائل</h2>
    <button class="mobile-toggle" id="mobileToggle">
      <i class="bx bx-menu"></i>
    </button>
  </div>

  <!-- الهيدر الثابت -->
  <div class="fixed-header" id="fixedHeader">
    <h2 class="header-title" id="headerTitle">لوحة المعلومات</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" id="logoutHeaderBtn"><i class="bx bx-log-out"></i> خروج</button>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="main-content" id="mainContent" style="display: none;"> <!-- Hidden by default -->
    <!-- قسم لوحة المعلومات -->
    <div class="section active" id="dashboardSection">
      <h3>لوحة المعلومات الرئيسية</h3>
      <div class="stats-container">
        <div class="stat-card">
          <h4>إجمالي القبائل</h4>
          <div class="stat-value" id="totalTribes">0</div>
          <div class="stat-label">المضافة في النظام</div>
        </div>
        <div class="stat-card">
          <h4>إجمالي الشيوخ</h4>
          <div class="stat-value" id="totalSheikhs">0</div>
          <div class="stat-label">المضافين في النظام</div>
        </div>
        <div class="stat-card">
          <h4>إجمالي الزوار</h4>
          <div class="stat-value" id="totalVisitors">0</div>
          <div class="stat-label">منذ إطلاق الموقع</div>
        </div>
        <div class="stat-card">
          <h4>زوار اليوم</h4>
          <div class="stat-value" id="todayVisitors">0</div>
          <div class="stat-label">خلال 24 ساعة</div>
        </div>
      </div>
      <hr class="section-divider">
      <h4>أحدث الإضافات</h4>
      <p>سيتم عرض أحدث القبائل والشيوخ المضافين هنا قريباً.</p>
    </div>

    <!-- قسم إضافة قبيلة -->
    <div class="section" id="addTribeSection">
      <h3>إضافة قبيلة جديدة</h3>
      <div class="alert alert-success" id="addTribeSuccess">تمت إضافة القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="addTribeError">حدث خطأ أثناء إضافة القبيلة.</div>
      <form id="addTribeForm">
        <div class="form-group">
          <label for="tribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="tribeName" placeholder="مثال: عتيبة" required>
        </div>
        <div class="form-group">
          <label for="tribeCode">رمز القبيلة</label>
          <input type="text" class="form-control" id="tribeCode" placeholder="مثال: 511" required>
        </div>
        <div class="form-group">
          <label for="tribeOrigin">أصل القبيلة</label>
          <input type="text" class="form-control" id="tribeOrigin" placeholder="مثال: قبيلة هوازنية عدنانية">
        </div>
        <button type="submit" class="btn btn-primary">إضافة القبيلة</button>
      </form>
    </div>

    <!-- قسم حذف قبيلة -->
    <div class="section" id="deleteTribeSection">
      <h3>حذف قبيلة</h3>
      <div class="alert alert-success" id="deleteTribeSuccess">تم حذف القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="deleteTribeError">حدث خطأ أثناء حذف القبيلة.</div>
      <form id="deleteTribeForm">
        <div class="form-group">
          <label for="tribeNameToDelete">اسم القبيلة</label>
          <input type="text" class="form-control" id="tribeNameToDelete" placeholder="أدخل اسم القبيلة المراد حذفها" required>
        </div>
        <button type="submit" class="btn btn-danger">حذف القبيلة</button>
      </form>
    </div>

    <!-- قسم إدارة شيوخ القبائل -->
    <div class="section" id="sheikhManagementSection">
      <h3>إدارة شيوخ القبائل</h3>
      <div class="result-message success-message" id="sheikhSuccessMessage"></div>
      <div class="result-message error-message" id="sheikhErrorMessage"></div>
      <div class="loading-spinner" id="sheikhLoadingSpinner"><i class="bx bx-loader-alt"></i></div>
      
      <form id="addSheikhForm">
        <h4>إضافة شيخ جديد</h4>
        <div class="form-group">
          <label for="sheikhTribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="sheikhTribeName" placeholder="مثال: آل حميقان" required>
        </div>
        <div class="form-group">
          <label for="sheikhName">اسم الشيخ</label>
          <input type="text" class="form-control" id="sheikhName" placeholder="مثال: الشيخ محمد بن ناصر" required>
        </div>
        <div class="form-group">
          <label>صورة الشيخ</label>
          <div class="image-upload">
            <input type="file" id="sheikhImage" accept="image/*">
            <i class="bx bx-cloud-upload"></i>
            <p>اسحب الصورة إلى هنا أو انقر للاختيار</p>
            <p id="imageInfo" style="font-size: 0.8em; color: #777; margin-top: 5px;"></p>
          </div>
          <div class="image-preview-container">
              <img id="sheikhImagePreview" class="image-preview" alt="معاينة الصورة">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">إضافة الشيخ</button>
      </form>
      
      <hr class="section-divider">
      
      <h4>قائمة الشيوخ الحاليين</h4>
      <div style="overflow-x: auto;"> <!-- Add scroll for small screens -->
          <table class="sheikhs-table" id="sheikhsListTable">
              <thead>
                  <tr>
                      <th>الصورة</th>
                      <th>اسم الشيخ</th>
                      <th>اسم القبيلة</th>
                      <th>إجراءات</th>
                  </tr>
              </thead>
              <tbody>
                  <!-- سيتم ملء الصفوف هنا بواسطة JavaScript -->
              </tbody>
          </table>
      </div>
    </div>

    <!-- قسم حذف شيخ قبيلة -->
    <div class="section" id="deleteSheikhSection">
      <h3>حذف شيخ قبيلة</h3>
      <div class="alert alert-success" id="deleteSheikhSuccess">تم حذف الشيخ بنجاح!</div>
      <div class="alert alert-danger" id="deleteSheikhError">حدث خطأ أثناء حذف الشيخ.</div>
      <form id="deleteSheikhForm">
        <div class="form-group">
          <label for="sheikhTribeNameToDelete">اسم القبيلة</label>
          <input type="text" class="form-control" id="sheikhTribeNameToDelete" placeholder="أدخل اسم قبيلة الشيخ المراد حذفه" required>
        </div>
        <button type="submit" class="btn btn-danger">حذف شيخ القبيلة</button>
      </form>
    </div>

    <!-- قسم إضافة معلومات القبائل -->
    <div class="section" id="addHistorySection">
      <h3>إضافة معلومات تاريخية لقبيلة</h3>
      <div class="alert alert-success" id="addHistorySuccess">تمت إضافة المعلومات بنجاح!</div>
      <div class="alert alert-danger" id="addHistoryError">حدث خطأ أثناء إضافة المعلومات.</div>
      <form id="addHistoryForm">
        <div class="form-group">
          <label for="historyTribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="historyTribeName" placeholder="اسم القبيلة التي ستضيف لها المعلومات" required>
        </div>
        <div id="historyDetailsContainer">
          <div class="form-group history-detail-item">
            <label>العنصر 1</label>
            <input type="text" class="form-control history-key" placeholder="مثال: أبرز المعارك" required>
            <textarea class="form-control history-value" placeholder="تفاصيل العنصر..." required></textarea>
          </div>
        </div>
        <button type="button" class="btn btn-secondary" id="addHistoryDetailBtn" style="margin-bottom: 15px;">إضافة عنصر آخر</button>
        <br>
        <button type="submit" class="btn btn-primary">حفظ المعلومات</button>
      </form>
    </div>

    <!-- قسم حذف معلومات القبائل -->
    <div class="section" id="deleteHistorySection">
      <h3>حذف معلومات قبيلة</h3>
      <div class="alert alert-success" id="deleteHistorySuccess">تم حذف معلومات القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="deleteHistoryError">حدث خطأ أثناء حذف معلومات القبيلة.</div>
      <form id="deleteHistoryForm">
        <div class="form-group">
          <label for="tribeNameDeleteHistory">اسم القبيلة</label>
          <input type="text" class="form-control" id="tribeNameDeleteHistory" placeholder="أدخل اسم القبيلة لحذف معلوماتها" required>
        </div>
        <button type="submit" class="btn btn-danger">حذف المعلومات</button>
      </form>
    </div>
    
    <!-- قسم إحصائيات الزوار -->
    <div class="section" id="visitorStatsSection">
      <h3>إحصائيات زوار الموقع</h3>
      
      <div class="visitor-stats-filters">
        <button class="filter-btn" onclick="displayVisitorStats(\'total\')">إجمالي الزوار</button>
        <button class="filter-btn" onclick="displayVisitorStats(\'today\')">زوار اليوم</button>
        <button class="filter-btn" onclick="displayVisitorStats(\'yesterday\')">زوار الأمس</button>
        <button class="filter-btn" onclick="displayVisitorStats(\'week\')">زوار هذا الأسبوع</button>
        <button class="filter-btn" onclick="displayVisitorStats(\'month\')">زوار هذا الشهر</button>
      </div>
      
      <div class="visitor-stats-display">
        <p>الزوار (<span id="visitorStatPeriod">الإجمالي</span>): <strong id="visitorStatCount">جاري التحميل...</strong></p>
        <p id="visitorStatMessage" style="font-size: 0.9em; color: #777;"></p>
      </div>
      
      <div class="stats-container">
        <div class="stat-card">
          <h4>إجمالي الزوار</h4>
          <div class="stat-value" id="totalVisitorsStats">0</div>
          <div class="stat-label">منذ إطلاق الموقع</div>
        </div>
        <div class="stat-card">
          <h4>زوار اليوم</h4>
          <div class="stat-value" id="todayVisitorsStats">0</div>
          <div class="stat-label">خلال 24 ساعة</div>
        </div>
        <div class="stat-card">
          <h4>زوار الأسبوع</h4>
          <div class="stat-value" id="weekVisitorsStats">0</div>
          <div class="stat-label">آخر 7 أيام</div>
        </div>
        <div class="stat-card">
          <h4>زوار الشهر</h4>
          <div class="stat-value" id="monthVisitorsStats">0</div>
          <div class="stat-label">آخر 30 يوم</div>
        </div>
      </div>
      
      <hr class="section-divider">
      
      <h4>إدارة بيانات الزوار</h4>
      <button class="btn btn-danger" onclick="clearAllVisitorData()" id="clearVisitorsBtn"><i class="bx bx-trash"></i> مسح جميع بيانات الزوار</button>
    </div>
  </div>
  
  <!-- مؤشر المعالجة -->
  <div class="processing-indicator" id="processingIndicator">
      <div class="spinner"></div>
      <p>جاري المعالجة...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, writeBatch, doc, deleteDoc, serverTimestamp, orderBy, limit, getDoc, setDoc, Timestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // إزالة استيراد Firebase Storage
    // import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // تكوين Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDGLwl69D9W5c03G5WsfU8pahvVHL4zKzs",
      authDomain: "tribes-project-18d2b.firebaseapp.com",
      projectId: "tribes-project-18d2b",
      // إزالة storageBucket لأنه لم يعد مستخدماً
      // storageBucket: "tribes-project-18d2b.appspot.com",
      messagingSenderId: "375771927234",
      appId: "1:375771927234:web:5fa0ec96fd9c80fce7615b"
    };

    // تهيئة Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // إزالة تهيئة Storage
    // const storage = getStorage(app);

    // عناصر الواجهة
    const sidebar = document.getElementById(\'sidebar\');
    const sidebarToggle = document.getElementById(\'sidebarToggle\');
    const mobileToggle = document.getElementById(\'mobileToggle\');
    const mainContent = document.getElementById(\'mainContent\');
    const fixedHeader = document.getElementById(\'fixedHeader\');
    const mobileHeader = document.querySelector(\".mobile-header\");
    const menuLinks = document.querySelectorAll(\".sidebar-menu a\");
    const sections = document.querySelectorAll(\".section\");
    const processingIndicator = document.getElementById(\'processingIndicator\');
    const loginScreen = document.getElementById(\'login-screen\');
    const headerTitle = document.getElementById(\'headerTitle\');
    const sidebarOverlay = document.getElementById(\'sidebarOverlay\');
    
    // عناصر تسجيل الدخول
    const loginButton = document.getElementById(\'loginButton\');
    const logoutLink = document.getElementById(\'logoutLink\');
    const logoutHeaderBtn = document.getElementById(\'logoutHeaderBtn\');
    
    // التحقق من حالة تسجيل الدخول
    function checkLoginStatus() {
      // دائماً عرض شاشة تسجيل الدخول عند تحميل الصفحة
      showLoginForm();
    }
    
    // عرض نموذج تسجيل الدخول
    function showLoginForm() {
      loginScreen.style.display = \'block\';
      mainContent.style.display = \'none\';
      sidebar.style.display = \'none\';
      fixedHeader.style.display = \'none\';
      mobileHeader.style.display = \'none\';
      sidebarOverlay.style.display = \'none\';
      sidebar.classList.add(\'collapsed\'); // Ensure sidebar is collapsed
      sidebar.classList.remove(\'active\');
      mainContent.classList.remove(\'expanded\');
      fixedHeader.classList.remove(\'expanded\');
    }
    
    // عرض لوحة التحكم
    function showDashboard() {
      loginScreen.style.display = \'none\';
      mainContent.style.display = \'block\';
      sidebar.style.display = \'flex\'; // Show sidebar
      
      // Handle header display based on screen size
      if (window.innerWidth <= 768) {
        mobileHeader.style.display = \'flex\';
        fixedHeader.style.display = \'none\';
      } else {
        mobileHeader.style.display = \'none\';
        fixedHeader.style.display = \'flex\';
      }
      
      loadDashboardData();
      fetchTotalVisitorCountForSidebar();
      // Ensure sidebar starts collapsed on desktop
      if (window.innerWidth > 768) {
          sidebar.classList.add(\'collapsed\');
          sidebar.classList.remove(\'active\');
          mainContent.classList.remove(\'expanded\');
          fixedHeader.classList.remove(\'expanded\');
      } else {
          // On mobile, ensure it starts collapsed but ready to be toggled
          sidebar.classList.add(\'collapsed\');
          sidebar.classList.remove(\'active\');
      }
      updateHeaderIcons(); // Update icons based on initial state
    }
    
    // معالجة تسجيل الدخول
    loginButton.addEventListener(\'click\', function() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      
      // بيانات تسجيل دخول بسيطة
      if (username === "Sahm" && password === "na1000856") {
        showDashboard();
      } else {
        alert("بيانات الدخول غير صحيحة!");
      }
    });
    
    // إضافة مستمع للضغط على Enter في حقل كلمة المرور
    const passwordInput = document.getElementById("password");
    if (passwordInput) {
      passwordInput.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          loginButton.click();
        }
      });
    }
    
    // تسجيل الخروج
    function handleLogout() {
      showLoginForm();
    }
    
    logoutLink.addEventListener(\'click\', function(e) {
      e.preventDefault();
      handleLogout();
    });
    
    logoutHeaderBtn.addEventListener(\'click\', handleLogout);

    // تبديل القائمة الجانبية
    sidebarToggle.addEventListener(\'click\', toggleSidebar);
    mobileToggle.addEventListener(\'click\', toggleSidebar);
    sidebarOverlay.addEventListener(\'click\', toggleSidebar); // Close on overlay click

    function toggleSidebar() {
      const isCollapsed = sidebar.classList.toggle(\'collapsed\');
      sidebar.classList.toggle(\'active\', !isCollapsed);
      mainContent.classList.toggle(\'expanded\', isCollapsed);
      fixedHeader.classList.toggle(\'expanded\', isCollapsed);
      
      // Show/hide overlay on mobile
      if (window.innerWidth <= 768) {
          sidebarOverlay.style.display = isCollapsed ? \'none\' : \'block\';
      }
      
      updateHeaderIcons();
    }
    
    function updateHeaderIcons() {
        const isCollapsed = sidebar.classList.contains(\'collapsed\');
        // Update desktop toggle icon
        const desktopIcon = sidebarToggle.querySelector(\'i\');
        if (desktopIcon) {
            desktopIcon.className = isCollapsed ? \'bx bx-menu\' : \'bx bx-x\';
        }
        // Update mobile toggle icon
        const mobileIcon = mobileToggle.querySelector(\'i\');
        if (mobileIcon) {
            mobileIcon.className = isCollapsed ? \'bx bx-menu\' : \'bx bx-x\';
        }
    }

    // التنقل بين الأقسام
    menuLinks.forEach(link => {
      if (link.id !== \'logoutLink\') {
        link.addEventListener(\'click\', function(e) {
          e.preventDefault();
          
          // إزالة الفئة النشطة من جميع الروابط
          menuLinks.forEach(item => item.classList.remove(\'active\'));
          // إضافة الفئة النشطة للرابط الحالي
          this.classList.add(\'active\');
          
          // إخفاء جميع الأقسام
          sections.forEach(section => section.classList.remove(\'active\'));
          
          // إظهار القسم المستهدف
          const sectionId = this.getAttribute(\'data-section\');
          const targetSection = document.getElementById(sectionId);
          if (targetSection) {
            targetSection.classList.add(\'active\');
            // تحديث عنوان الهيدر
            headerTitle.textContent = this.textContent.trim();
            // تحميل البيانات الخاصة بالقسم إذا لزم الأمر
            if (sectionId === \'sheikhManagementSection\') {
                loadSheikhs();
            } else if (sectionId === \'dashboardSection\') {
                loadDashboardData();
            } else if (sectionId === \'visitorStatsSection\') {
                displayVisitorStats(\'total\'); // Load total stats by default
            }
          }
          
          // إغلاق القائمة الجانبية تلقائياً بعد اختيار قسم (خاصة في الجوال)
          if (window.innerWidth <= 768 && !sidebar.classList.contains(\'collapsed\')) {
            toggleSidebar();
          }
        });
      }
    });

    // إضافة مستمع لإغلاق القائمة عند النقر خارجها (باستثناء زر التبديل)
    document.addEventListener(\'click\', function(event) {
      const isClickInsideSidebar = sidebar.contains(event.target);
      const isClickOnDesktopToggle = sidebarToggle.contains(event.target);
      const isClickOnMobileToggle = mobileToggle.contains(event.target);
      const isSidebarActive = sidebar.classList.contains(\'active\');

      if (!isClickInsideSidebar && !isClickOnDesktopToggle && !isClickOnMobileToggle && isSidebarActive) {
          // Don\'t close if click is on toggles
          if (window.innerWidth > 768) { // Only close on outside click on desktop if active
             toggleSidebar();
          }
          // Mobile closing is handled by overlay click
      }
    });

    // معاينة الصورة
    const sheikhImageInput = document.getElementById(\'sheikhImage\');
    const sheikhImagePreview = document.getElementById(\'sheikhImagePreview\');
    const imageInfo = document.getElementById(\'imageInfo\');
    const MAX_IMAGE_SIZE_MB = 5; // تحديد الحد الأقصى لحجم الصورة بالميجابايت
    let imageDataUrl = null; // لتخزين بيانات الصورة كـ Base64

    sheikhImageInput.addEventListener(\'change\', function(event) {
      const file = event.target.files[0];
      if (file) {
        // التحقق من حجم الصورة
        const fileSizeMB = file.size / 1024 / 1024;
        if (fileSizeMB > MAX_IMAGE_SIZE_MB) {
            showSheikhMessage(`حجم الصورة يتجاوز الحد المسموح به (${MAX_IMAGE_SIZE_MB} ميجابايت).`, \'error\');
            sheikhImageInput.value = \'\'; // مسح اختيار الملف
            sheikhImagePreview.style.display = \'none\';
            imageInfo.textContent = \'\';
            imageDataUrl = null;
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          sheikhImagePreview.src = e.target.result;
          sheikhImagePreview.style.display = \'block\';
          imageDataUrl = e.target.result; // تخزين بيانات الصورة
          imageInfo.textContent = `اسم الملف: ${file.name}, الحجم: ${(fileSizeMB).toFixed(2)} ميجابايت`;
        }
        reader.readAsDataURL(file);
      } else {
          sheikhImagePreview.style.display = \'none\';
          imageInfo.textContent = \'\';
          imageDataUrl = null;
      }
    });

    // إضافة شيخ جديد
    const addSheikhForm = document.getElementById(\'addSheikhForm\');
    addSheikhForm.addEventListener(\'submit\', async function(e) {
      e.preventDefault();
      showProcessingIndicator(true, \'sheikhLoadingSpinner\');
      hideSheikhMessages();

      const tribeName = document.getElementById(\'sheikhTribeName\').value.trim();
      const sheikhName = document.getElementById(\'sheikhName\').value.trim();

      if (!tribeName || !sheikhName || !imageDataUrl) {
        showSheikhMessage(\'الرجاء ملء جميع الحقول واختيار صورة.\', \'error\');
        showProcessingIndicator(false, \'sheikhLoadingSpinner\');
        return;
      }

      try {
        // التحقق مما إذا كان الشيخ موجودًا بالفعل لهذه القبيلة
        const sheikhsRef = collection(db, "sheikhs");
        const q = query(sheikhsRef, where("tribeName", "==", tribeName));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
            // إذا كانت القبيلة موجودة، تحقق من اسم الشيخ
            let sheikhExists = false;
            querySnapshot.forEach(doc => {
                if (doc.data().sheikhName === sheikhName) {
                    sheikhExists = true;
                }
            });
            if (sheikhExists) {
                showSheikhMessage(\'هذا الشيخ مضاف بالفعل لهذه القبيلة.\', \'error\');
                showProcessingIndicator(false, \'sheikhLoadingSpinner\');
                return;
            }
            // يمكنك هنا أن تقرر ما إذا كنت تريد تحديث الشيخ الحالي أو منع إضافة شيخ آخر لنفس القبيلة
            // حاليًا، سيتم إضافة شيخ جديد حتى لو كانت القبيلة موجودة ولكن باسم شيخ مختلف
        }

        // إضافة الشيخ الجديد
        await addDoc(collection(db, "sheikhs"), {
          tribeName: tribeName,
          sheikhName: sheikhName,
          imageUrl: imageDataUrl, // حفظ الصورة كـ Base64
          addedAt: serverTimestamp()
        });
        showSheikhMessage(\'تمت إضافة الشيخ بنجاح!\', \'success\');
        addSheikhForm.reset();
        sheikhImagePreview.style.display = \'none\';
        imageInfo.textContent = \'\';
        imageDataUrl = null;
        loadSheikhs(); // إعادة تحميل قائمة الشيوخ
        fetchDashboardCounts(); // تحديث العدادات في لوحة المعلومات
      } catch (error) {
        console.error("خطأ في إضافة الشيخ: ", error);
        showSheikhMessage(\'حدث خطأ أثناء إضافة الشيخ.\', \'error\');
      } finally {
        showProcessingIndicator(false, \'sheikhLoadingSpinner\');
      }
    });
    
    // تحميل قائمة الشيوخ
    async function loadSheikhs() {
        const tableBody = document.getElementById(\'sheikhsListTable\').querySelector(\'tbody\');
        tableBody.innerHTML = \'<tr><td colspan="4" style="text-align:center;">جاري تحميل الشيوخ...</td></tr>\'; // Show loading state
        
        try {
            const sheikhsRef = collection(db, "sheikhs");
            const q = query(sheikhsRef, orderBy("addedAt", "desc")); // Order by newest first
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = \'\'; // Clear loading/previous state
            if (querySnapshot.empty) {
                tableBody.innerHTML = \'<tr><td colspan="4" style="text-align:center;">لا يوجد شيوخ مضافون حالياً.</td></tr>\';
                return;
            }
            
            querySnapshot.forEach((doc) => {
                const sheikh = doc.data();
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><img src="${sheikh.imageUrl}" alt="صورة الشيخ" class="sheikh-image"></td>
                    <td>${sheikh.sheikhName}</td>
                    <td>${sheikh.tribeName}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteSheikh(\'${doc.id}\', \'${sheikh.tribeName}\', \'${sheikh.sheikhName}\')"><i class="bx bx-trash"></i> حذف</button>
                            <!-- Add edit button functionality later if needed -->
                            <!-- <button class="btn btn-secondary btn-sm"><i class="bx bx-edit"></i> تعديل</button> -->
                        </div>
                    </td>
                `;
            });
        } catch (error) {
            console.error("Error loading sheikhs: ", error);
            tableBody.innerHTML = \'<tr><td colspan="4" style="text-align:center;">حدث خطأ أثناء تحميل قائمة الشيوخ.</td></tr>\';
        }
    }
    
    // جعل دالة الحذف متاحة عالميًا
    window.deleteSheikh = async function(docId, tribeName, sheikhName) {
        if (!confirm(`هل أنت متأكد من رغبتك في حذف الشيخ \'${sheikhName}\' من قبيلة \'${tribeName}\'؟`)) {
            return;
        }
        
        showProcessingIndicator(true, \'sheikhLoadingSpinner\');
        hideSheikhMessages();
        
        try {
            const sheikhDocRef = doc(db, "sheikhs", docId);
            await deleteDoc(sheikhDocRef);
            showSheikhMessage(\'تم حذف الشيخ بنجاح.\', \'success\');
            loadSheikhs(); // Reload the list
            fetchDashboardCounts(); // Update dashboard counts
        } catch (error) {
            console.error("Error deleting sheikh: ", error);
            showSheikhMessage(\'حدث خطأ أثناء حذف الشيخ.\', \'error\');
        } finally {
            showProcessingIndicator(false, \'sheikhLoadingSpinner\');
        }
    }
    
    // عرض وإخفاء رسائل قسم الشيوخ
    function showSheikhMessage(message, type) {
        const successMsg = document.getElementById(\'sheikhSuccessMessage\');
        const errorMsg = document.getElementById(\'sheikhErrorMessage\');
        if (type === \'success\') {
            successMsg.textContent = message;
            successMsg.style.display = \'block\';
            errorMsg.style.display = \'none\';
        } else {
            errorMsg.textContent = message;
            errorMsg.style.display = \'block\';
            successMsg.style.display = \'none\';
        }
    }

    function hideSheikhMessages() {
        document.getElementById(\'sheikhSuccessMessage\').style.display = \'none\';
        document.getElementById(\'sheikhErrorMessage\').style.display = \'none\';
    }

    // عرض وإخفاء مؤشر المعالجة العام أو الخاص بقسم
    function showProcessingIndicator(show, spinnerId = null) {
        const indicator = spinnerId ? document.getElementById(spinnerId) : processingIndicator;
        if (indicator) {
            indicator.style.display = show ? (spinnerId ? \'block\' : \'flex\') : \'none\';
        }
    }

    // إضافة قبيلة
    const addTribeForm = document.getElementById(\'addTribeForm\');
    addTribeForm.addEventListener(\'submit\', async function(e) {
      e.preventDefault();
      showProcessingIndicator(true);
      hideAlerts(\'addTribe\');
      
      const name = document.getElementById(\'tribeName\').value.trim();
      const code = document.getElementById(\'tribeCode\').value.trim();
      const origin = document.getElementById(\'tribeOrigin\').value.trim();

      if (!name || !code) {
        showAlert(\'addTribeError\', \'الرجاء إدخال اسم القبيلة ورمزها.\');
        showProcessingIndicator(false);
        return;
      }

      try {
        // التحقق من عدم وجود القبيلة أو الرمز مسبقًا
        const tribesRef = collection(db, "tribes");
        const qName = query(tribesRef, where("name", "==", name));
        const qCode = query(tribesRef, where("code", "==", code));
        
        const nameSnapshot = await getDocs(qName);
        const codeSnapshot = await getDocs(qCode);
        
        if (!nameSnapshot.empty) {
            showAlert(\'addTribeError\', \'اسم القبيلة موجود بالفعل.\');
            showProcessingIndicator(false);
            return;
        }
        if (!codeSnapshot.empty) {
            showAlert(\'addTribeError\', \'رمز القبيلة مستخدم بالفعل.\');
            showProcessingIndicator(false);
            return;
        }

        await addDoc(collection(db, "tribes"), {
          name: name,
          code: code,
          origin: origin,
          addedAt: serverTimestamp()
        });
        showAlert(\'addTribeSuccess\', \'تمت إضافة القبيلة بنجاح!\');
        addTribeForm.reset();
        fetchDashboardCounts(); // تحديث العدادات
      } catch (error) {
        console.error("خطأ في إضافة القبيلة: ", error);
        showAlert(\'addTribeError\', \'حدث خطأ أثناء إضافة القبيلة.\');
      } finally {
        showProcessingIndicator(false);
      }
    });

    // حذف قبيلة
    const deleteTribeForm = document.getElementById(\'deleteTribeForm\');
    deleteTribeForm.addEventListener(\'submit\', async function(e) {
      e.preventDefault();
      showProcessingIndicator(true);
      hideAlerts(\'deleteTribe\');
      
      const nameToDelete = document.getElementById(\'tribeNameToDelete\').value.trim();
      if (!nameToDelete) {
        showAlert(\'deleteTribeError\', \'الرجاء إدخال اسم القبيلة للحذف.\');
        showProcessingIndicator(false);
        return;
      }

      if (!confirm(`هل أنت متأكد من رغبتك في حذف قبيلة \'${nameToDelete}\'؟ سيتم حذف جميع المعلومات المرتبطة بها (التاريخ، الشيوخ).`)) {
          showProcessingIndicator(false);
          return;
      }

      try {
        const tribesRef = collection(db, "tribes");
        const q = query(tribesRef, where("name", "==", nameToDelete));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          showAlert(\'deleteTribeError\', \'لم يتم العثور على قبيلة بهذا الاسم.\');
        } else {
          const batch = writeBatch(db);
          querySnapshot.forEach((doc) => {
            batch.delete(doc.ref);
          });
          
          // حذف المعلومات التاريخية المرتبطة
          const historyRef = collection(db, "tribeHistory");
          const qHistory = query(historyRef, where("tribeName", "==", nameToDelete));
          const historySnapshot = await getDocs(qHistory);
          historySnapshot.forEach((doc) => {
              batch.delete(doc.ref);
          });
          
          // حذف الشيوخ المرتبطين
          const sheikhsRef = collection(db, "sheikhs");
          const qSheikhs = query(sheikhsRef, where("tribeName", "==", nameToDelete));
          const sheikhsSnapshot = await getDocs(qSheikhs);
          sheikhsSnapshot.forEach((doc) => {
              batch.delete(doc.ref);
          });

          await batch.commit();
          showAlert(\'deleteTribeSuccess\', \'تم حذف القبيلة وجميع المعلومات المرتبطة بها بنجاح!\');
          deleteTribeForm.reset();
          fetchDashboardCounts(); // تحديث العدادات
          loadSheikhs(); // تحديث قائمة الشيوخ إذا كانت مفتوحة
        }
      } catch (error) {
        console.error("خطأ في حذف القبيلة: ", error);
        showAlert(\'deleteTribeError\', \'حدث خطأ أثناء حذف القبيلة.\');
      } finally {
        showProcessingIndicator(false);
      }
    });
    
    // إضافة معلومات تاريخية
    const addHistoryForm = document.getElementById(\'addHistoryForm\');
    const historyDetailsContainer = document.getElementById(\'historyDetailsContainer\');
    const addHistoryDetailBtn = document.getElementById(\'addHistoryDetailBtn\');
    let detailCounter = 1;

    addHistoryDetailBtn.addEventListener(\'click\', () => {
        detailCounter++;
        const newItem = document.createElement(\'div\');
        newItem.classList.add(\'form-group\', \'history-detail-item\');
        newItem.innerHTML = `
            <label>العنصر ${detailCounter}</label>
            <input type="text" class="form-control history-key" placeholder="عنوان العنصر ${detailCounter}" required>
            <textarea class="form-control history-value" placeholder="تفاصيل العنصر ${detailCounter}..." required></textarea>
            <button type="button" class="btn btn-danger btn-sm remove-detail-btn" style="margin-top: 5px;">إزالة</button>
        `;
        historyDetailsContainer.appendChild(newItem);
    });
    
    // إزالة عنصر تاريخي
    historyDetailsContainer.addEventListener(\'click\', (e) => {
        if (e.target.classList.contains(\'remove-detail-btn\')) {
            if (historyDetailsContainer.children.length > 1) { // Prevent removing the last item
                e.target.closest(\'.history-detail-item\').remove();
                // Optional: Renumber labels if needed
            } else {
                alert(\'يجب ترك عنصر واحد على الأقل.\');
            }
        }
    });

    addHistoryForm.addEventListener(\'submit\', async (e) => {
        e.preventDefault();
        showProcessingIndicator(true);
        hideAlerts(\'addHistory\');
        
        const tribeName = document.getElementById(\'historyTribeName\').value.trim();
        const detailItems = historyDetailsContainer.querySelectorAll(".history-detail-item");
        const details = [];
        let isValid = true;

        detailItems.forEach(item => {
            const keyInput = item.querySelector(".history-key");
            const valueInput = item.querySelector(".history-value");
            const key = keyInput.value.trim();
            const value = valueInput.value.trim();
            if (key && value) {
                details.push({ key, value });
            } else {
                isValid = false;
                keyInput.style.borderColor = key ? \'#D2B48C\' : \'red\';
                valueInput.style.borderColor = value ? \'#D2B48C\' : \'red\';
            }
        });

        if (!tribeName || !isValid || details.length === 0) {
            showAlert(\'addHistoryError\', \'الرجاء ملء اسم القبيلة وجميع حقول العناصر بشكل صحيح.\');
            showProcessingIndicator(false);
            return;
        }

        try {
            // التحقق من وجود القبيلة أولاً
            const tribesRef = collection(db, "tribes");
            const qTribe = query(tribesRef, where("name", "==", tribeName));
            const tribeSnapshot = await getDocs(qTribe);
            if (tribeSnapshot.empty) {
                showAlert(\'addHistoryError\', `لم يتم العثور على قبيلة باسم \'${tribeName}\'. يرجى إضافتها أولاً.`);
                showProcessingIndicator(false);
                return;
            }
            
            // التحقق مما إذا كانت هناك معلومات تاريخية موجودة بالفعل لهذه القبيلة
            const historyRef = collection(db, "tribeHistory");
            const qHistory = query(historyRef, where("tribeName", "==", tribeName));
            const historySnapshot = await getDocs(qHistory);

            if (!historySnapshot.empty) {
                // تحديث المستند الموجود
                const docRef = historySnapshot.docs[0].ref;
                await setDoc(docRef, { tribeName, details, lastUpdatedAt: serverTimestamp() }, { merge: true });
                showAlert(\'addHistorySuccess\', \'تم تحديث المعلومات التاريخية للقبيلة بنجاح!\');
            } else {
                // إضافة مستند جديد
                await addDoc(historyRef, {
                    tribeName: tribeName,
                    details: details,
                    addedAt: serverTimestamp()
                });
                showAlert(\'addHistorySuccess\', \'تمت إضافة المعلومات التاريخية بنجاح!\');
            }
            
            addHistoryForm.reset();
            // Reset dynamic fields
            historyDetailsContainer.innerHTML = `
                <div class="form-group history-detail-item">
                    <label>العنصر 1</label>
                    <input type="text" class="form-control history-key" placeholder="مثال: أبرز المعارك" required>
                    <textarea class="form-control history-value" placeholder="تفاصيل العنصر..." required></textarea>
                </div>
            `;
            detailCounter = 1;
            // Reset border colors
            detailItems.forEach(item => {
                item.querySelector(".history-key").style.borderColor = \'#D2B48C\';
                item.querySelector(".history-value").style.borderColor = \'#D2B48C\';
            });

        } catch (error) {
            console.error("خطأ في إضافة/تحديث المعلومات التاريخية: ", error);
            showAlert(\'addHistoryError\', \'حدث خطأ أثناء حفظ المعلومات التاريخية.\');
        } finally {
            showProcessingIndicator(false);
        }
    });
    
    // حذف معلومات تاريخية
    const deleteHistoryForm = document.getElementById(\'deleteHistoryForm\');
    deleteHistoryForm.addEventListener(\'submit\', async (e) => {
        e.preventDefault();
        showProcessingIndicator(true);
        hideAlerts(\'deleteHistory\');
        
        const tribeName = document.getElementById(\'tribeNameDeleteHistory\').value.trim();
        if (!tribeName) {
            showAlert(\'deleteHistoryError\', \'الرجاء إدخال اسم القبيلة لحذف معلوماتها.\');
            showProcessingIndicator(false);
            return;
        }
        
        if (!confirm(`هل أنت متأكد من رغبتك في حذف جميع المعلومات التاريخية لقبيلة \'${tribeName}\'؟`)) {
            showProcessingIndicator(false);
            return;
        }
        
        try {
            const historyRef = collection(db, "tribeHistory");
            const q = query(historyRef, where("tribeName", "==", tribeName));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                showAlert(\'deleteHistoryError\', \'لا توجد معلومات تاريخية مسجلة لهذه القبيلة.\');
            } else {
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showAlert(\'deleteHistorySuccess\', \'تم حذف المعلومات التاريخية للقبيلة بنجاح!\');
                deleteHistoryForm.reset();
            }
        } catch (error) {
            console.error("خطأ في حذف المعلومات التاريخية: ", error);
            showAlert(\'deleteHistoryError\', \'حدث خطأ أثناء حذف المعلومات التاريخية.\');
        } finally {
            showProcessingIndicator(false);
        }
    });

    // وظائف المساعدة للرسائل
    function showAlert(elementId, message) {
      const alertElement = document.getElementById(elementId);
      alertElement.textContent = message;
      alertElement.style.display = \'block\';
    }

    function hideAlerts(prefix) {
      document.getElementById(prefix + \'Success\').style.display = \'none\';
      document.getElementById(prefix + \'Error\').style.display = \'none\';
    }
    
    // تحميل بيانات لوحة المعلومات (العدادات)
    async function fetchDashboardCounts() {
        try {
            const tribesSnap = await getDocs(collection(db, "tribes"));
            const sheikhsSnap = await getDocs(collection(db, "sheikhs"));
            const totalVisitorsSnap = await getDoc(doc(db, "siteAnalytics", "totalVisitors"));
            const todayDateString = getFormattedDate(new Date());
            const todayVisitorsSnap = await getDoc(doc(db, "siteAnalyticsByDay", todayDateString));

            document.getElementById(\'totalTribes\').textContent = tribesSnap.size;
            document.getElementById(\'totalSheikhs\').textContent = sheikhsSnap.size;
            document.getElementById(\'totalVisitors\').textContent = totalVisitorsSnap.exists() ? totalVisitorsSnap.data().count : 0;
            document.getElementById(\'todayVisitors\').textContent = todayVisitorsSnap.exists() ? todayVisitorsSnap.data().count : 0;
            
        } catch (error) {
            console.error("Error fetching dashboard counts: ", error);
            // Optionally display an error message on the dashboard
        }
    }
    
    // تحميل إجمالي الزوار للشريط الجانبي
    async function fetchTotalVisitorCountForSidebar() {
        try {
            const totalVisitorsRef = doc(db, "siteAnalytics", "totalVisitors");
            const docSnap = await getDoc(totalVisitorsRef);
            const count = docSnap.exists() ? docSnap.data().count : 0;
            document.getElementById(\'sidebarVisitorCount\').textContent = `إجمالي الزوار: ${count}`;
        } catch (error) {
            console.error("Error fetching total visitor count for sidebar: ", error);
            document.getElementById(\'sidebarVisitorCount\').textContent = "خطأ في تحميل الزوار";
        }
    }

    // تحميل بيانات لوحة المعلومات عند الحاجة
    function loadDashboardData() {
        fetchDashboardCounts();
        // Add logic here later to load recent additions if needed
    }
    
    // --- قسم إحصائيات الزوار --- 
    
    // تنسيق التاريخ (YYYY-MM-DD)
    function getFormattedDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, \'0\')}-${String(date.getDate()).padStart(2, \'0\')}`;
    }
    
    // عرض إحصائيات الزوار حسب الفترة
    window.displayVisitorStats = async function(period) {
        const countEl = document.getElementById(\'visitorStatCount\');
        const periodEl = document.getElementById(\'visitorStatPeriod\');
        const messageEl = document.getElementById(\'visitorStatMessage\');
        countEl.textContent = \'جاري التحميل...\';
        messageEl.textContent = \'\';
        let count = 0;
        let periodText = \'\';
        const now = new Date();

        try {
            if (period === \'total\') {
                periodText = \'الإجمالي\';
                const totalSnap = await getDoc(doc(db, "siteAnalytics", "totalVisitors"));
                count = totalSnap.exists() ? totalSnap.data().count : 0;
            } else if (period === \'today\') {
                periodText = \'اليوم\';
                const todayStr = getFormattedDate(now);
                const todaySnap = await getDoc(doc(db, "siteAnalyticsByDay", todayStr));
                count = todaySnap.exists() ? todaySnap.data().count : 0;
            } else if (period === \'yesterday\') {
                periodText = \'الأمس\';
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                const yesterdayStr = getFormattedDate(yesterday);
                const yesterdaySnap = await getDoc(doc(db, "siteAnalyticsByDay", yesterdayStr));
                count = yesterdaySnap.exists() ? yesterdaySnap.data().count : 0;
            } else if (period === \'week\') {
                periodText = \'هذا الأسبوع\';
                for (let i = 0; i < 7; i++) {
                    const day = new Date(now);
                    day.setDate(now.getDate() - i);
                    const dayStr = getFormattedDate(day);
                    const daySnap = await getDoc(doc(db, "siteAnalyticsByDay", dayStr));
                    if (daySnap.exists()) {
                        count += daySnap.data().count || 0;
                    }
                }
            } else if (period === \'month\') {
                periodText = \'هذا الشهر\';
                 for (let i = 0; i < 30; i++) { // Approximation for month
                    const day = new Date(now);
                    day.setDate(now.getDate() - i);
                    const dayStr = getFormattedDate(day);
                    const daySnap = await getDoc(doc(db, "siteAnalyticsByDay", dayStr));
                    if (daySnap.exists()) {
                        count += daySnap.data().count || 0;
                    }
                }
            }
            
            periodEl.textContent = periodText;
            countEl.textContent = count;
            
            // تحديث الكروت الإحصائية أيضاً
            if (period === \'total\') document.getElementById(\'totalVisitorsStats\').textContent = count;
            if (period === \'today\') document.getElementById(\'todayVisitorsStats\').textContent = count;
            if (period === \'week\') document.getElementById(\'weekVisitorsStats\').textContent = count;
            if (period === \'month\') document.getElementById(\'monthVisitorsStats\').textContent = count;
            
        } catch (error) {
            console.error(`Error fetching ${period} visitor stats: `, error);
            countEl.textContent = \'خطأ\';
            messageEl.textContent = \'حدث خطأ أثناء تحميل الإحصائيات.\';
        }
        
        // تحميل جميع الإحصائيات للكروت عند عرض القسم لأول مرة
        if (!document.getElementById(\'totalVisitorsStats\').textContent || document.getElementById(\'totalVisitorsStats\').textContent === \'0\') {
            loadAllStatsForCards();
        }
    }
    
    // تحميل جميع الإحصائيات للكروت المنفصلة
    async function loadAllStatsForCards() {
        try {
            const totalSnap = await getDoc(doc(db, "siteAnalytics", "totalVisitors"));
            document.getElementById(\'totalVisitorsStats\').textContent = totalSnap.exists() ? totalSnap.data().count : 0;

            const todayStr = getFormattedDate(new Date());
            const todaySnap = await getDoc(doc(db, "siteAnalyticsByDay", todayStr));
            document.getElementById(\'todayVisitorsStats\').textContent = todaySnap.exists() ? todaySnap.data().count : 0;

            let weekCount = 0;
            const now = new Date();
            for (let i = 0; i < 7; i++) {
                const day = new Date(now);
                day.setDate(now.getDate() - i);
                const dayStr = getFormattedDate(day);
                const daySnap = await getDoc(doc(db, "siteAnalyticsByDay", dayStr));
                if (daySnap.exists()) weekCount += (daySnap.data().count || 0);
            }
            document.getElementById(\'weekVisitorsStats\').textContent = weekCount;

            let monthCount = 0;
            for (let i = 0; i < 30; i++) {
                const day = new Date(now);
                day.setDate(now.getDate() - i);
                const dayStr = getFormattedDate(day);
                const daySnap = await getDoc(doc(db, "siteAnalyticsByDay", dayStr));
                if (daySnap.exists()) monthCount += (daySnap.data().count || 0);
            }
            document.getElementById(\'monthVisitorsStats\').textContent = monthCount;

        } catch (error) {
            console.error("Error loading stats for cards: ", error);
        }
    }
    
    // مسح جميع بيانات الزوار (لأغراض الاختبار أو إعادة الضبط)
    window.clearAllVisitorData = async function() {
        if (!confirm("تحذير: سيؤدي هذا إلى حذف جميع سجلات إحصائيات الزوار اليومية والإجمالية بشكل دائم. هل أنت متأكد من المتابعة؟")) {
            return;
        }
        
        showProcessingIndicator(true);
        const clearBtn = document.getElementById(\'clearVisitorsBtn\');
        clearBtn.disabled = true;
        clearBtn.textContent = \'جاري المسح...\';
        
        try {
            const batch = writeBatch(db);
            
            // حذف السجل الإجمالي
            const totalRef = doc(db, "siteAnalytics", "totalVisitors");
            batch.delete(totalRef);
            
            // حذف السجلات اليومية (قد تحتاج إلى طريقة أكثر فعالية للإنتاج)
            const dailyCollectionRef = collection(db, "siteAnalyticsByDay");
            const dailySnapshot = await getDocs(dailyCollectionRef);
            dailySnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            
            // مسح التخزين المحلي للمستخدمين الحاليين
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(\'visitor_\')) {
                    localStorage.removeItem(key);
                }
            });
            
            alert(\'تم مسح جميع بيانات الزوار بنجاح.\');
            // إعادة تحميل الإحصائيات المعروضة
            displayVisitorStats(\'total\');
            loadAllStatsForCards();
            fetchTotalVisitorCountForSidebar();
            
        } catch (error) {
            console.error("Error clearing visitor data: ", error);
            alert(\'حدث خطأ أثناء مسح بيانات الزوار.\');
        } finally {
            showProcessingIndicator(false);
            clearBtn.disabled = false;
            clearBtn.innerHTML = \'<i class="bx bx-trash"></i> مسح جميع بيانات الزوار\';
        }
    }

    // --- نهاية قسم إحصائيات الزوار ---
    
    // التحقق من حالة تسجيل الدخول عند تحميل الصفحة
    checkLoginStatus();
    
    // إضافة مستمع لتغيير حجم النافذة لضبط عرض الهيدر
    window.addEventListener(\'resize\', function() {
      if (loginScreen.style.display === \'none\') { // Only adjust if logged in
          if (window.innerWidth <= 768) {
            mobileHeader.style.display = \'flex\';
            fixedHeader.style.display = \'none\';
            sidebarOverlay.style.display = sidebar.classList.contains(\'active\') ? \'block\' : \'none\'; // Show overlay if sidebar is active
          } else {
            mobileHeader.style.display = \'none\';
            fixedHeader.style.display = \'flex\';
            sidebarOverlay.style.display = \'none\'; // Hide overlay on desktop
            // Ensure sidebar state is correct on resize
            if (sidebar.classList.contains(\'active\')) {
                // If sidebar was active (mobile), collapse it on desktop resize
                toggleSidebar(); 
            }
          }
      }
    });

  </script>
</body>
</html>
