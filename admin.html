<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم رموز القبائل</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      background: linear-gradient(135deg, #FAF3E0, #F2E8D5);
      color: #5C4033;
      min-height: 100vh;
      display: flex;
    }
    
    /* القائمة الجانبية */
    .sidebar {
      width: 250px;
      background: rgba(139, 69, 19, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      height: 100vh;
      position: fixed;
      right: 0;
      top: 0;
      transition: transform 0.3s ease;
      z-index: 1000;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar.collapsed {
      transform: translateX(250px);
    }
    
    .sidebar-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-header h2 {
      color: #fff;
      margin: 0;
      font-size: 1.2rem;
    }
    
    .toggle-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .toggle-btn.active {
      transform: rotate(180deg);
    }
    
    .sidebar-menu {
      padding: 20px 0;
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .sidebar-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 12px 20px;
      color: #fff;
      text-decoration: none;
      transition: background 0.3s;
      border-radius: 4px;
      margin: 0 10px;
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-menu a i {
      margin-left: 10px;
      font-size: 1.2rem;
      vertical-align: middle;
    }
    
    .sidebar-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
    }
    
    /* المحتوى الرئيسي */
    .main-content {
      flex: 1;
      padding: 20px;
      margin-right: 250px;
      transition: margin 0.3s ease;
    }
    
    .main-content.expanded {
      margin-right: 0;
    }
    
    .mobile-header {
      display: none;
      padding: 15px;
      background: rgba(139, 69, 19, 0.9);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      color: #fff;
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    /* الأقسام */
    .section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .section h3 {
      margin-top: 0;
      color: #3E2723;
      border-bottom: 2px solid #D2B48C;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    /* النماذج */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #5C4033;
      font-weight: bold;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #D2B48C;
      border-radius: 5px;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      color: #3E2723;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .form-control:focus {
      border-color: #CD853F;
      box-shadow: 0 0 5px rgba(205, 133, 63, 0.3);
      outline: none;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: "IBM Plex Sans Arabic", sans-serif;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, #CD853F, #D2B48C);
      color: #fff;
    }
    
    .btn-primary:hover {
      background: linear-gradient(90deg, #D2B48C, #CD853F);
    }
    
    .btn-danger {
      background: linear-gradient(90deg, #d9534f, #c9302c);
      color: #fff;
    }
    
    .btn-danger:hover {
      background: linear-gradient(90deg, #c9302c, #d9534f);
    }
    
    /* تحميل الصور */
    .image-upload {
      border: 2px dashed #D2B48C;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      transition: border-color 0.3s;
    }
    
    .image-upload:hover {
      border-color: #CD853F;
    }
    
    .image-upload input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .image-upload i {
      font-size: 40px;
      color: #D2B48C;
      margin-bottom: 10px;
    }
    
    .image-upload p {
      margin: 0;
      color: #5C4033;
    }
    
    .image-preview {
      max-width: 100%;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
      max-height: 300px;
    }
    
    /* رسائل النجاح والخطأ */
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }
    
    .alert-success {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    
    .alert-danger {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    
    /* تصميم متجاوب */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(250px);
        width: 250px;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-right: 0;
        padding-top: 70px;
      }
      
      .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .mobile-header h2 {
        margin: 0;
        font-size: 1.2rem;
      }
    }
    
    /* تنسيق إضافي لقسم إدارة شيوخ القبائل */
    #sheikhManagementSection .image-preview-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    #sheikhManagementSection .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* تنسيق لرسائل النجاح والفشل */
    .result-message {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      display: none;
    }
    
    .success-message {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    
    .error-message {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    
    /* تنسيق للمؤشر أثناء التحميل */
    .loading-spinner {
      display: none;
      text-align: center;
      margin: 15px 0;
    }
    
    .loading-spinner i {
      font-size: 24px;
      color: #CD853F;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- القائمة الجانبية -->
  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-header">
      <h2>لوحة التحكم</h2>
      <button class="toggle-btn" id="sidebarToggle">
        <i class="bx bx-x"></i>
      </button>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="#" data-section="tribeCodeSection" class="active"><i class="bx bx-hash"></i> إدارة رموز القبائل</a></li>
        <li><a href="#" data-section="tribeHistorySection"><i class="bx bx-book-open"></i> إدارة معلومات القبائل</a></li>
        <li><a href="#" data-section="sheikhManagementSection"><i class="bx bx-user"></i> إدارة شيوخ القبائل</a></li>
        <li><a href="#" data-section="deleteCodeSection"><i class="bx bx-trash"></i> حذف رموز القبائل</a></li>
        <li><a href="#" data-section="deleteHistorySection"><i class="bx bx-trash-alt"></i> حذف معلومات القبائل</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      تم التطوير بواسطة سهم الحميقاني
    </div>
  </div>
  
  <!-- رأس الصفحة للجوال -->
  <div class="mobile-header">
    <h2>لوحة تحكم رموز القبائل</h2>
    <button class="mobile-toggle" id="mobileToggle">
      <i class="bx bx-menu"></i>
    </button>
  </div>
  
  <!-- المحتوى الرئيسي -->
  <div class="main-content expanded" id="mainContent">
    <!-- قسم إدارة رموز القبائل -->
    <div class="section active" id="tribeCodeSection">
      <h3>إضافة رمز قبيلة</h3>
      <div class="alert alert-success" id="tribeCodeSuccess">تم إضافة رمز القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="tribeCodeError">حدث خطأ أثناء إضافة رمز القبيلة.</div>
      <form id="tribeCodeForm">
        <div class="form-group">
          <label for="tribeCode">رمز القبيلة</label>
          <input type="text" class="form-control" id="tribeCode" placeholder="مثال: 711" required>
        </div>
        <div class="form-group">
          <label for="tribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="tribeName" placeholder="مثال: دهم" required>
        </div>
        <button type="submit" class="btn btn-primary">إضافة الرمز</button>
      </form>
    </div>
    
    <!-- قسم إدارة معلومات القبائل -->
    <div class="section" id="tribeHistorySection">
      <h3>إضافة معلومات قبيلة</h3>
      <div class="alert alert-success" id="tribeHistorySuccess">تم إضافة معلومات القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="tribeHistoryError">حدث خطأ أثناء إضافة معلومات القبيلة.</div>
      <form id="tribeHistoryForm">
        <div class="form-group">
          <label for="historyTribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="historyTribeName" placeholder="مثال: دهم" required>
        </div>
        <div class="form-group">
          <label for="tribeHistory">معلومات وتاريخ القبيلة</label>
          <textarea class="form-control" id="tribeHistory" placeholder="أدخل معلومات وتاريخ القبيلة هنا..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">إضافة المعلومات</button>
      </form>
    </div>
    
    <!-- قسم إدارة شيوخ القبائل -->
    <div class="section" id="sheikhManagementSection">
      <h3>إضافة شيخ قبيلة</h3>
      
      <!-- رسائل النجاح والفشل -->
      <div class="result-message success-message" id="sheikhSuccessMessage">تم إضافة شيخ القبيلة بنجاح! رقم المستند: <span id="documentId"></span></div>
      <div class="result-message error-message" id="sheikhErrorMessage">حدث خطأ أثناء إضافة شيخ القبيلة. يرجى المحاولة مرة أخرى.</div>
      
      <!-- مؤشر التحميل -->
      <div class="loading-spinner" id="sheikhLoadingSpinner">
        <i class="bx bx-loader-alt"></i>
        <p>جاري معالجة الطلب...</p>
      </div>
      
      <form id="sheikhForm">
        <div class="form-group">
          <label for="sheikhTribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="sheikhTribeName" placeholder="مثال: آل حميقان" required>
        </div>
        <div class="form-group">
          <label for="sheikhName">اسم الشيخ</label>
          <input type="text" class="form-control" id="sheikhName" placeholder="مثال: الشيخ محمد بن ناصر" required>
        </div>
        <div class="form-group">
          <label>صورة الشيخ</label>
          <div class="image-upload">
            <i class="bx bx-image-add"></i>
            <p>انقر لاختيار صورة أو اسحب الصورة هنا</p>
            <input type="file" id="sheikhImage" accept="image/*">
          </div>
          <div class="image-preview-container">
            <img id="sheikhImagePreview" class="image-preview" alt="معاينة صورة الشيخ">
          </div>
          <p class="text-muted">* يفضل استخدام صورة بأبعاد متناسبة (مثل 600×400 بكسل)</p>
        </div>
        <button type="submit" class="btn btn-primary">إضافة الشيخ</button>
      </form>
    </div>
    
    <!-- قسم حذف رموز القبائل -->
    <div class="section" id="deleteCodeSection">
      <h3>حذف رمز قبيلة</h3>
      <div class="alert alert-success" id="deleteCodeSuccess">تم حذف رمز القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="deleteCodeError">حدث خطأ أثناء حذف رمز القبيلة.</div>
      <form id="deleteCodeForm">
        <div class="form-group">
          <label for="deleteCode">رمز القبيلة</label>
          <input type="text" class="form-control" id="deleteCode" placeholder="أدخل رمز القبيلة للحذف" required>
        </div>
        <div class="form-group">
          <label for="deleteCodeTribeName">اسم القبيلة</label>
          <input type="text" class="form-control" id="deleteCodeTribeName" placeholder="أدخل اسم القبيلة للتأكيد" required>
        </div>
        <button type="submit" class="btn btn-danger">حذف الرمز</button>
      </form>
    </div>
    
    <!-- قسم حذف معلومات القبائل -->
    <div class="section" id="deleteHistorySection">
      <h3>حذف معلومات قبيلة</h3>
      <div class="alert alert-success" id="deleteHistorySuccess">تم حذف معلومات القبيلة بنجاح!</div>
      <div class="alert alert-danger" id="deleteHistoryError">حدث خطأ أثناء حذف معلومات القبيلة.</div>
      <form id="deleteHistoryForm">
        <div class="form-group">
          <label for="tribeNameDeleteHistory">اسم القبيلة</label>
          <input type="text" class="form-control" id="tribeNameDeleteHistory" placeholder="أدخل اسم القبيلة لحذف معلوماتها" required>
        </div>
        <button type="submit" class="btn btn-danger">حذف المعلومات</button>
      </form>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, writeBatch, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // تكوين Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDGLwl69D9W5c03G5WsfU8pahvVHL4zKzs",
      authDomain: "tribes-project-18d2b.firebaseapp.com",
      projectId: "tribes-project-18d2b",
      storageBucket: "tribes-project-18d2b.appspot.com",
      messagingSenderId: "375771927234",
      appId: "1:375771927234:web:5fa0ec96fd9c80fce7615b"
    };

    // تهيئة Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // عناصر القائمة الجانبية
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mobileToggle = document.getElementById('mobileToggle');
    const mainContent = document.getElementById('mainContent');
    const menuLinks = document.querySelectorAll('.sidebar-menu a');
    const sections = document.querySelectorAll('.section');

    // تبديل القائمة الجانبية
    sidebarToggle.addEventListener('click', toggleSidebar);
    mobileToggle.addEventListener('click', toggleSidebar);

    function toggleSidebar() {
      sidebar.classList.toggle('collapsed');
      sidebar.classList.toggle('active');
      mainContent.classList.toggle('expanded');
      
      // تبديل أيقونة الزر
      const icon = sidebarToggle.querySelector('i');
      if (sidebar.classList.contains('collapsed')) {
        icon.className = 'bx bx-menu';
      } else {
        icon.className = 'bx bx-x';
      }
      
      // تبديل أيقونة الزر في الهاتف
      const mobileIcon = mobileToggle.querySelector('i');
      if (sidebar.classList.contains('active')) {
        mobileIcon.className = 'bx bx-x';
      } else {
        mobileIcon.className = 'bx bx-menu';
      }
    }

    // التنقل بين الأقسام
    menuLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // إزالة الفئة النشطة من جميع الروابط
        menuLinks.forEach(item => item.classList.remove('active'));
        
        // إضافة الفئة النشطة للرابط المحدد
        this.classList.add('active');
        
        // إخفاء جميع الأقسام
        sections.forEach(section => section.classList.remove('active'));
        
        // إظهار القسم المحدد
        const targetSection = document.getElementById(this.getAttribute('data-section'));
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // إغلاق القائمة الجانبية في الأجهزة المحمولة
        if (window.innerWidth <= 768) {
          toggleSidebar();
        }
      });
    });

    // معاينة الصورة
    const sheikhImage = document.getElementById('sheikhImage');
    const sheikhImagePreview = document.getElementById('sheikhImagePreview');

    sheikhImage.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          sheikhImagePreview.src = e.target.result;
          sheikhImagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // نموذج إضافة رمز قبيلة
    const tribeCodeForm = document.getElementById('tribeCodeForm');
    const tribeCodeSuccess = document.getElementById('tribeCodeSuccess');
    const tribeCodeError = document.getElementById('tribeCodeError');

    tribeCodeForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const code = document.getElementById('tribeCode').value.trim();
      const name = document.getElementById('tribeName').value.trim();
      
      tribeCodeSuccess.style.display = 'none';
      tribeCodeError.style.display = 'none';
      
      try {
        await addDoc(collection(db, "tribes"), {
          code: code,
          name: name,
          timestamp: serverTimestamp()
        });
        
        tribeCodeSuccess.style.display = 'block';
        tribeCodeForm.reset();
        setTimeout(() => { tribeCodeSuccess.style.display = 'none'; }, 5000);
      } catch (error) {
        console.error("خطأ في إضافة رمز القبيلة: ", error);
        tribeCodeError.style.display = 'block';
        setTimeout(() => { tribeCodeError.style.display = 'none'; }, 5000);
      }
    });

    // نموذج إضافة معلومات قبيلة
    const tribeHistoryForm = document.getElementById('tribeHistoryForm');
    const tribeHistorySuccess = document.getElementById('tribeHistorySuccess');
    const tribeHistoryError = document.getElementById('tribeHistoryError');

    tribeHistoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('historyTribeName').value.trim();
      const history = document.getElementById('tribeHistory').value.trim();
      
      tribeHistorySuccess.style.display = 'none';
      tribeHistoryError.style.display = 'none';
      
      try {
        await addDoc(collection(db, "histories"), {
          name: name,
          history: history,
          timestamp: serverTimestamp()
        });
        
        tribeHistorySuccess.style.display = 'block';
        tribeHistoryForm.reset();
        setTimeout(() => { tribeHistorySuccess.style.display = 'none'; }, 5000);
      } catch (error) {
        console.error("خطأ في إضافة معلومات القبيلة: ", error);
        tribeHistoryError.style.display = 'block';
        setTimeout(() => { tribeHistoryError.style.display = 'none'; }, 5000);
      }
    });

    // نموذج إضافة شيخ قبيلة
    const sheikhForm = document.getElementById('sheikhForm');
    const sheikhSuccessMessage = document.getElementById('sheikhSuccessMessage');
    const sheikhErrorMessage = document.getElementById('sheikhErrorMessage');
    const sheikhLoadingSpinner = document.getElementById('sheikhLoadingSpinner');
    const documentIdSpan = document.getElementById('documentId');

    sheikhForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const tribeName = document.getElementById('sheikhTribeName').value.trim();
      const sheikhName = document.getElementById('sheikhName').value.trim();
      const imageFile = document.getElementById('sheikhImage').files[0];
      
      // إخفاء الرسائل وإظهار مؤشر التحميل
      sheikhSuccessMessage.style.display = 'none';
      sheikhErrorMessage.style.display = 'none';
      sheikhLoadingSpinner.style.display = 'block';
      
      if (!imageFile) {
        sheikhErrorMessage.textContent = "يرجى اختيار صورة للشيخ";
        sheikhErrorMessage.style.display = 'block';
        sheikhLoadingSpinner.style.display = 'none';
        return;
      }
      
      try {
        // تحميل الصورة إلى Firebase Storage
        const timestamp = new Date().getTime();
        const imageName = `sheikh_images/${tribeName}_${timestamp}`;
        const storageRef = ref(storage, imageName);
        
        // تحميل الصورة
        await uploadBytes(storageRef, imageFile);
        
        // الحصول على رابط الصورة
        const imageUrl = await getDownloadURL(storageRef);
        
        // إضافة بيانات الشيخ إلى Firestore
        const docRef = await addDoc(collection(db, "sheikhs"), {
          tribeName: tribeName,
          sheikhName: sheikhName,
          imageUrl: imageUrl,
          imagePath: imageName,
          timestamp: serverTimestamp()
        });
        
        // عرض رسالة النجاح مع رقم المستند
        documentIdSpan.textContent = docRef.id;
        sheikhSuccessMessage.style.display = 'block';
        sheikhForm.reset();
        sheikhImagePreview.style.display = 'none';
        
        // إخفاء رسالة النجاح بعد 10 ثوانٍ
        setTimeout(() => { sheikhSuccessMessage.style.display = 'none'; }, 10000);
      } catch (error) {
        console.error("خطأ في إضافة شيخ القبيلة: ", error);
        sheikhErrorMessage.textContent = `حدث خطأ أثناء إضافة شيخ القبيلة: ${error.message}`;
        sheikhErrorMessage.style.display = 'block';
      } finally {
        // إخفاء مؤشر التحميل
        sheikhLoadingSpinner.style.display = 'none';
      }
    });

    // نموذج حذف رمز قبيلة
    const deleteCodeForm = document.getElementById('deleteCodeForm');
    const deleteCodeSuccess = document.getElementById('deleteCodeSuccess');
    const deleteCodeError = document.getElementById('deleteCodeError');

    deleteCodeForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const code = document.getElementById('deleteCode').value.trim();
      const tribeName = document.getElementById('deleteCodeTribeName').value.trim();
      
      deleteCodeSuccess.style.display = 'none';
      deleteCodeError.style.display = 'none';
      
      const confirmation = confirm(`هل أنت متأكد أنك تريد حذف رمز القبيلة "${code}" (${tribeName})؟ هذا الإجراء لا يمكن التراجع عنه.`);
      if (!confirmation) return;
      
      try {
        let deletedCount = 0;
        const tribesRef = collection(db, "tribes");
        const batch = writeBatch(db);
        
        const q = query(tribesRef, where("code", "==", code), where("name", "==", tribeName));
        const snapshot = await getDocs(q);
        
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
          deletedCount++;
        });
        
        if (deletedCount > 0) {
          await batch.commit();
          deleteCodeSuccess.textContent = `تم حذف ${deletedCount} من سجلات رمز القبيلة "${code}" (${tribeName}) بنجاح.`;
          deleteCodeSuccess.style.display = 'block';
          deleteCodeForm.reset();
          setTimeout(() => { deleteCodeSuccess.style.display = 'none'; }, 5000);
        } else {
          deleteCodeError.textContent = `لم يتم العثور على رمز القبيلة "${code}" مع الاسم "${tribeName}".`;
          deleteCodeError.style.display = 'block';
          setTimeout(() => { deleteCodeError.style.display = 'none'; }, 5000);
        }
      } catch (error) {
        console.error("خطأ في حذف رمز القبيلة: ", error);
        deleteCodeError.textContent = `فشلت عملية حذف رمز القبيلة. الخطأ: ${error.message}`;
        deleteCodeError.style.display = 'block';
        setTimeout(() => { deleteCodeError.style.display = 'none'; }, 5000);
      }
    });

    // نموذج حذف معلومات قبيلة
    const deleteHistoryForm = document.getElementById('deleteHistoryForm');
    const deleteHistorySuccess = document.getElementById('deleteHistorySuccess');
    const deleteHistoryError = document.getElementById('deleteHistoryError');

    deleteHistoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('tribeNameDeleteHistory').value.trim();
      
      deleteHistorySuccess.style.display = 'none';
      deleteHistoryError.style.display = 'none';
      
      const confirmation = confirm(`هل أنت متأكد أنك تريد حذف جميع معلومات وتاريخ القبيلة "${name}"؟ هذا الإجراء لا يمكن التراجع عنه.`);
      if (!confirmation) return;
      
      try {
        let deletedCount = 0;
        const historiesRef = collection(db, "histories");
        const batch = writeBatch(db);
        
        const qByName = query(historiesRef, where("name", "==", name));
        const snapshotByName = await getDocs(qByName);
        
        snapshotByName.forEach(doc => {
          batch.delete(doc.ref);
          deletedCount++;
        });
        
        if (deletedCount > 0) {
          await batch.commit();
          deleteHistorySuccess.textContent = `تم حذف ${deletedCount} من سجلات معلومات وتاريخ القبيلة "${name}" بنجاح.`;
          deleteHistorySuccess.style.display = 'block';
          deleteHistoryForm.reset();
          setTimeout(() => { deleteHistorySuccess.style.display = 'none'; }, 5000);
        } else {
          deleteHistoryError.textContent = `لم يتم العثور على معلومات أو تاريخ للقبيلة بالاسم: "${name}".`;
          deleteHistoryError.style.display = 'block';
          setTimeout(() => { deleteHistoryError.style.display = 'none'; }, 5000);
        }
      } catch (error) {
        console.error("خطأ في حذف معلومات القبيلة: ", error);
        deleteHistoryError.textContent = `فشلت عملية حذف معلومات القبيلة. الخطأ: ${error.message}`;
        deleteHistoryError.style.display = 'block';
        setTimeout(() => { deleteHistoryError.style.display = 'none'; }, 5000);
      }
    });
  </script>
</body>
</html>
